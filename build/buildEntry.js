const fs = require('fs')
const render = require('json-templater/string')
const path = require('path')
const endOfLine = require('os').EOL

const OUTPUT_PATH = path.join(__dirname, '../src/index.js')

let IMPORT_TEMPLATE = 'const {{name}} = require(\'./{{name}}.js\')'
const MAIN_TEMPLATE = `/* Automatic generated by './build/buildEntry.js' */

{{include}}

module.exports = {
{{list}}
}
`

const srcDir = fs.readdirSync(path.resolve(__dirname, '../src'))
const nameArr = srcDir
  .filter(item => /\.js$/.test(item) && item !== 'index.js')
  .map(file => file.match(/\w+(?=\.js$)/)[0])

const includeComponentTemplate = []
const listTemplate = []

nameArr.forEach(name => {
  includeComponentTemplate.push(render(IMPORT_TEMPLATE, {
    name: name
  }))
  listTemplate.push(`  ${name}`)
})

const template = render(MAIN_TEMPLATE, {
  include: includeComponentTemplate.join(endOfLine),
  list: listTemplate.join(',' + endOfLine)
})

module.exports = function () {
  fs.writeFileSync(OUTPUT_PATH, template)
  console.log('[build entry] DONE:', OUTPUT_PATH)
}
